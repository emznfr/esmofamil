<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Nom & Pr√©nom ‚Äî Multiplayer</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:#f6f7fb}
    .wrap{max-width:980px;margin:0 auto;padding:14px}
    .card{background:#fff;border-radius:16px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);margin-bottom:12px}
    h1{margin:0 0 8px;font-size:20px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1;min-width:160px}
    input,button{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;font-size:14px;box-sizing:border-box}
    button{border:none;background:#2563eb;color:#fff;font-weight:800;cursor:pointer}
    button.secondary{background:#eef2ff;color:#1e3a8a}
    button.danger{background:#ef4444}
    .muted{color:#6b7280;font-size:12px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#f1f5ff;color:#1e3a8a;font-weight:900;font-size:12px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    @media(max-width:600px){.grid{grid-template-columns:1fr}}
    .answers{display:flex;flex-direction:column;gap:8px}
    .answer{border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fbfdff}
    .meta{font-weight:900;margin-bottom:6px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eef2f7;padding:8px;text-align:left;font-size:14px}
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <h1>Nom & Pr√©nom ‚Äî Multijoueur</h1>
    <div class="row">
      <input id="name" placeholder="Votre nom (ex: Roham)" />
      <input id="code" placeholder="Code salle (ex: ABC12)" />
    </div>
    <div class="row" style="margin-top:8px">
      <button id="createBtn">Cr√©er une salle</button>
      <button id="joinBtn" class="secondary">Rejoindre</button>
    </div>
    <div class="muted" id="status" style="margin-top:8px">‚Äî</div>
  </div>

  <div class="card">
    <div class="row">
      <button id="startBtn" class="secondary">D√©marrer une manche (Host)</button>
      <button id="endBtn" class="danger">Finir la manche (Host)</button>
    </div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <span class="pill">Salle: <span id="roomCode">‚Äî</span></span>
      <span class="pill">Statut: <span id="roomStatus">‚Äî</span></span>
      <span class="pill">Lettre: <span id="roomLetter">‚Äî</span></span>
      <span class="pill">Soumissions: <span id="subCount">0</span></span>
    </div>
  </div>

  <div class="card">
    <h1>R√©ponses</h1>
    <div class="grid" id="formGrid"></div>
    <div class="row" style="margin-top:10px">
      <button id="submitBtn">Envoyer mes r√©ponses</button>
    </div>
    <div class="muted" id="submitMsg" style="margin-top:8px">‚Äî</div>
  </div>

  <div class="card">
    <h1>R√©ponses de tout le monde (NE DOIT PAS DISPARA√éTRE)</h1>
    <div class="answers" id="answersList"></div>
  </div>

  <div class="card">
    <h1>Scores</h1>
    <table>
      <thead><tr><th>Joueur</th><th>Total</th><th>Round</th></tr></thead>
      <tbody id="scoresBody"></tbody>
    </table>
  </div>

</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  const el = {
    name: document.getElementById("name"),
    code: document.getElementById("code"),
    createBtn: document.getElementById("createBtn"),
    joinBtn: document.getElementById("joinBtn"),
    status: document.getElementById("status"),
    startBtn: document.getElementById("startBtn"),
    endBtn: document.getElementById("endBtn"),
    roomCode: document.getElementById("roomCode"),
    roomStatus: document.getElementById("roomStatus"),
    roomLetter: document.getElementById("roomLetter"),
    subCount: document.getElementById("subCount"),
    formGrid: document.getElementById("formGrid"),
    submitBtn: document.getElementById("submitBtn"),
    submitMsg: document.getElementById("submitMsg"),
    answersList: document.getElementById("answersList"),
    scoresBody: document.getElementById("scoresBody"),
  };

  let currentCode = null;
  let roomState = null;

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function renderForm(categories){
    el.formGrid.innerHTML = "";
    categories.forEach(cat=>{
      const id = "cat_" + cat;
      el.formGrid.insertAdjacentHTML("beforeend", `
        <div>
          <div class="muted" style="margin-bottom:6px">${esc(cat)}</div>
          <input id="${esc(id)}" placeholder="${esc(cat)}..." />
        </div>
      `);
    });
  }

  function getAnswers(categories){
    const a = {};
    categories.forEach(cat=>{
      const input = document.getElementById("cat_"+cat);
      a[cat] = input ? input.value : "";
    });
    return a;
  }

  function addOrUpdateAnswerCard(entry){
    // Ÿáÿ± ÿ®ÿßÿ≤€å⁄©ŸÜ ŸÅŸÇÿ∑ €å⁄© ⁄©ÿßÿ±ÿ™ (ÿ¢ÿÆÿ±€åŸÜ Ÿæÿßÿ≥ÿÆ ŸáŸÖÿßŸÜ ÿ®ÿßÿ≤€å⁄©ŸÜ)
    const existing = document.getElementById("ans_" + entry.playerId);
    const html = `
      <div class="answer" id="ans_${esc(entry.playerId)}">
        <div class="meta">üë§ ${esc(entry.name || entry.playerId)}</div>
        <div class="muted">${Object.entries(entry.answers || {})
          .map(([k,v])=>`<strong>${esc(k)}</strong>: ${esc(v || "‚Äî")}`)
          .join(" | ")
        }</div>
      </div>
    `;
    if(existing) existing.outerHTML = html;
    else el.answersList.insertAdjacentHTML("beforeend", html);
  }

  // ‚úÖ €±) ŸàŸÇÿ™€å Join ŸÖ€å‚Äå⁄©ŸÜ€å: ⁄©ŸÑ ÿ¨Ÿàÿßÿ®‚ÄåŸáÿß€å ŸÅÿπŸÑ€å ÿ±ÿß €å⁄©ÿ¨ÿß ŸÜŸÖÿß€åÿ¥ ÿ®ÿØŸá
  socket.on("submissions:init", (list) => {
    // ŸÖŸáŸÖ: ÿß€åŸÜÿ¨ÿß ŸÅŸÇÿ∑ ŸáŸÜ⁄ØÿßŸÖ init Ÿæÿß⁄© ŸÖ€å‚Äå⁄©ŸÜ€åŸÖÿå ŸÜŸá ŸáŸÜ⁄ØÿßŸÖ submit
    el.answersList.innerHTML = "";
    (list || []).forEach(addOrUpdateAnswerCard);
  });

  // ‚úÖ €≤) Ÿáÿ± ⁄©ÿ≥€å Submit ÿ≤ÿØ: ŸÅŸÇÿ∑ ŸáŸÖÿßŸÜ entry ÿ±ÿß ÿßÿ∂ÿßŸÅŸá/ÿ¢ŸæÿØ€åÿ™ ⁄©ŸÜ
  socket.on("submission:added", (entry) => {
    addOrUpdateAnswerCard(entry);
  });

  // Ÿàÿ∂ÿπ€åÿ™ ÿßÿ™ÿßŸÇ
  socket.on("room:state", (state) => {
    roomState = state;
    currentCode = state.code;

    el.roomCode.textContent = state.code || "‚Äî";
    el.roomStatus.textContent = state.status || "‚Äî";
    el.roomLetter.textContent = state.letter || "‚Äî";
    el.subCount.textContent = String(state.submissionsCount || 0);

    if(state.categories) renderForm(state.categories);

    // ÿ¨ÿØŸàŸÑ ÿßÿ≥⁄©Ÿàÿ± ⁄©ŸÑ
    const idToName = new Map((state.players||[]).map(p=>[p.id,p.name]));
    el.scoresBody.innerHTML = (state.totals||[])
      .map(t=>`<tr><td>${esc(idToName.get(t.id)||t.id)}</td><td>${esc(t.score)}</td><td>‚Äî</td></tr>`)
      .join("");
  });

  // ÿ¢ŸæÿØ€åÿ™ ÿßÿ≥⁄©Ÿàÿ± ÿ±ÿßŸÜÿØ + ŸÖÿ¨ŸÖŸàÿπ
  socket.on("scores:update", ({ totals, round }) => {
    const idToName = new Map((roomState?.players||[]).map(p=>[p.id,p.name]));
    const roundMap = new Map((round||[]).map(x=>[x.id,x.score]));
    el.scoresBody.innerHTML = (totals||[])
      .map(t=>`<tr>
        <td>${esc(idToName.get(t.id)||t.id)}</td>
        <td>${esc(t.score)}</td>
        <td>${esc(roundMap.get(t.id) ?? 0)}</td>
      </tr>`).join("");
  });

  // Create / Join
  el.createBtn.onclick = () => {
    const name = el.name.value.trim() || "Player";
    socket.emit("room:create", { name }, (res) => {
      if(!res?.ok) return el.status.textContent = "Erreur cr√©ation";
      el.status.textContent = "Salle cr√©√©e: " + res.code;
      el.code.value = res.code;
      currentCode = res.code;
    });
  };

  el.joinBtn.onclick = () => {
    const name = el.name.value.trim() || "Player";
    const code = el.code.value.trim().toUpperCase();
    socket.emit("room:join", { code, name }, (res) => {
      if(!res?.ok) return el.status.textContent = "Salle introuvable";
      el.status.textContent = "Rejoint: " + code;
      currentCode = code;
    });
  };

  el.startBtn.onclick = () => {
    if(!currentCode) return;
    socket.emit("round:start", { code: currentCode, durationSec: 120 });
  };

  el.endBtn.onclick = () => {
    if(!currentCode) return;
    socket.emit("round:end", { code: currentCode });
  };

  el.submitBtn.onclick = () => {
    if(!currentCode) return;
    if(!roomState?.categories) return;

    const answers = getAnswers(roomState.categories);
    socket.emit("submit", { code: currentCode, answers }, (res) => {
      el.submitMsg.textContent = res?.ok ? "‚úÖ Envoy√©" : "‚ùå Erreur envoi";
    });
  };
</script>
</body>
</html>

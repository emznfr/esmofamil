<!doctype html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ø§Ø³Ù… ÙØ§Ù…ÛŒÙ„ Ø¢Ù†Ù„Ø§ÛŒÙ†</title>
    <style>
        :root { --p: #4f46e5; --bg: #f8fafc; --danger: #ef4444; --success: #22c55e; }
        body { font-family: system-ui; background: var(--bg); margin: 0; padding: 15px; }
        .wrap { max-width: 900px; margin: 0 auto; }
        .card { background: #fff; border-radius: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h1 { font-size: 22px; text-align: center; color: var(--p); margin: 0 0 20px; }
        .input-group { display: grid; gap: 10px; margin-bottom: 15px; grid-template-columns: 1fr 1fr; }
        input, select, button { padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 14px; }
        button { cursor: pointer; font-weight: bold; transition: 0.2s; border: none; }
        .btn-p { background: var(--p); color: white; }
        .btn-success { background: var(--success); color: white; }
        .timer-bar { height: 6px; background: #e2e8f0; border-radius: 10px; margin: 10px 0; overflow: hidden; }
        .timer-progress { height: 100%; background: var(--p); width: 100%; transition: width 1s linear; }
        .timer-progress.low { background: var(--danger); }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .field-card { background: #f1f5f9; padding: 10px; border-radius: 12px; }
        .field-card label { display: block; font-size: 11px; font-weight: bold; margin-bottom: 5px; color: #444; }
        .field-card input { width: 100%; border: none; background: transparent; font-size: 14px; resize: none; min-height: 40px; overflow: hidden; }
        .score-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f5f9; }
        .player-status { font-size: 12px; color: #666; margin-top: 10px; }
        .copy-btn { font-size: 12px; padding: 4px 8px; margin-right: 8px; }

        /* Review Table */
        .table-wrap { overflow-x: auto; margin-top: 15px; }
        table { width: 100%; min-width: 600px; border-collapse: collapse; font-size: 13px; }
        th, td { border: 1px solid #e2e8f0; padding: 8px; text-align: center; vertical-align: middle; }
        th { background: #f8fafc; }
        .points-btn { padding: 4px 8px; font-size: 11px; margin: 2px; border-radius: 6px; min-width: 32px; }
        .btn-0 { background: #ddd; color: #333; }
        .btn-5 { background: #fbbf24; color: white; }
        .btn-10 { background: var(--success); color: white; }
        .round-total { font-weight: bold; color: var(--p); font-size: 14px; }
    </style>
</head>
<body>
<div class="wrap">
    <div class="card" id="authBox">
        <h1 id="title">ğŸ“ Ø§Ø³Ù… ÙØ§Ù…ÛŒÙ„ Ø¢Ù†Ù„Ø§ÛŒÙ† (Ù†Ø³Ø®Ù‡ Ø¯Ø§ÙˆØ±ÛŒ)</h1>
        <div class="input-group">
            <input id="nameInput" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§" />
            <select id="langSelect">
                <option value="fa">ÙØ§Ø±Ø³ÛŒ</option>
                <option value="en">English</option>
                <option value="fr">FranÃ§ais</option>
            </select>
        </div>
        <div class="input-group">
            <button class="btn-p" id="createBtn">Ø³Ø§Ø®Øª Ø§ØªØ§Ù‚</button>
            <input id="codeInput" placeholder="Ú©Ø¯ Ø§ØªØ§Ù‚" />
        </div>
        <button class="btn-p" id="joinBtn" style="width:100%; margin-top:5px">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø§ØªØ§Ù‚</button>
    </div>

    <div class="card" id="gameInfo" style="display:none">
        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 10px;">
            <div>
                <div id="roomPill" style="font-weight:bold">Ø§ØªØ§Ù‚: â€”</div>
                <div style="font-size:12px; color:#666" id="playersCount">Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†: 0</div>
            </div>
            <div style="text-align:center">
                <div id="statusBadge" style="color:var(--p); font-weight:bold">Lobby</div>
                <button id="copyCodeBtn" class="copy-btn btn-p" style="display:none">Ú©Ù¾ÛŒ Ú©Ø¯</button>
            </div>
        </div>

        <div id="hostControls" style="display:none; margin-top:15px">
            <input id="durationInput" type="number" value="120" style="width:80px" min="30" />
            <button class="btn-p" id="startBtn">Ø´Ø±ÙˆØ¹ Ø±Ø§Ù†Ø¯</button>
        </div>

        <div id="playerStatus" class="player-status"></div>
        <div id="scoresList" style="margin-top:15px"></div>
    </div>

    <div class="card" id="playArea" style="display:none">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <div style="font-weight:bold">Ø­Ø±Ù: <span id="letterBox" style="color:var(--p); font-size:20px">ØŸ</span></div>
            <div id="timerText" style="font-weight:bold">120s</div>
        </div>
        <div class="timer-bar"><div id="timerProgress" class="timer-progress"></div></div>
        <div id="inputsGrid" class="grid"></div>
        <button class="btn-p" id="submitBtn" style="width:100%; margin-top:15px">Ø§Ø±Ø³Ø§Ù„ Ú©Ù„Ù…Ø§Øª</button>
    </div>

    <div class="card" id="reviewArea" style="display:none">
        <h2 style="font-size:16px" id="reviewTitle">ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù„Ù…Ø§Øª (Ù…Ø®ØµÙˆØµ Ù…ÛŒØ²Ø¨Ø§Ù†)</h2>
        <div class="table-wrap">
            <table id="reviewTable">
                <thead><tr id="tableHeader"></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        <button id="finishReviewBtn" class="btn-success" style="width:100%; margin-top:15px; display:none">Ù¾Ø§ÛŒØ§Ù† Ø¯Ø§ÙˆØ±ÛŒ Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„Ø§Ø¨ÛŒ</button>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const CATEGORIES = ["name","family","city","country","animal","food","fruit","object","color","job"];

    const i18n = {
        fa: {
            title: "ğŸ“ Ø§Ø³Ù… ÙØ§Ù…ÛŒÙ„ Ø¢Ù†Ù„Ø§ÛŒÙ† (Ù†Ø³Ø®Ù‡ Ø¯Ø§ÙˆØ±ÛŒ)",
            namePlaceholder: "Ù†Ø§Ù… Ø´Ù…Ø§",
            createRoom: "Ø³Ø§Ø®Øª Ø§ØªØ§Ù‚",
            joinRoom: "ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø§ØªØ§Ù‚",
            roomCode: "Ú©Ø¯ Ø§ØªØ§Ù‚",
            startRound: "Ø´Ø±ÙˆØ¹ Ø±Ø§Ù†Ø¯",
            submitWords: "Ø§Ø±Ø³Ø§Ù„ Ú©Ù„Ù…Ø§Øª",
            submitted: "ÙØ±Ø³ØªØ§Ø¯Ù‡ Ø´Ø¯",
            reviewTitle: "ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù„Ù…Ø§Øª (Ù…Ø®ØµÙˆØµ Ù…ÛŒØ²Ø¨Ø§Ù†)",
            finishReview: "Ù¾Ø§ÛŒØ§Ù† Ø¯Ø§ÙˆØ±ÛŒ Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„Ø§Ø¨ÛŒ",
            letter: "Ø­Ø±Ù",
            players: "Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†",
            scores: "Ø§Ù…ØªÛŒØ§Ø²Ø§Øª",
            copyCode: "Ú©Ù¾ÛŒ Ú©Ø¯",
            copied: "Ú©Ù¾ÛŒ Ø´Ø¯!",
            allSubmitted: "Ù‡Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„ Ú©Ø±Ø¯Ù†Ø¯ â€” Ø¯Ø§ÙˆØ±ÛŒ Ø´Ø±ÙˆØ¹ Ø´Ø¯!"
        },
        en: {
            title: "ğŸ“ Esm Famil Online (Judging Version)",
            namePlaceholder: "Your name",
            createRoom: "Create Room",
            joinRoom: "Join Room",
            roomCode: "Room code",
            startRound: "Start Round",
            submitWords: "Submit Words",
            submitted: "Submitted",
            reviewTitle: "ğŸ” Word Review (Host Only)",
            finishReview: "Finish Review & Return to Lobby",
            letter: "Letter",
            players: "Players",
            scores: "Scores",
            copyCode: "Copy Code",
            copied: "Copied!",
            allSubmitted: "Everyone submitted â€” Review started!"
        },
        fr: {
            title: "ğŸ“ Nom de Famille En Ligne (Version Arbitrage)",
            namePlaceholder: "Votre nom",
            createRoom: "CrÃ©er une salle",
            joinRoom: "Rejoindre la salle",
            roomCode: "Code de salle",
            startRound: "DÃ©marrer le tour",
            submitWords: "Soumettre les mots",
            submitted: "EnvoyÃ©",
            reviewTitle: "ğŸ” Examen des mots (HÃ´te uniquement)",
            finishReview: "Terminer l'arbitrage et retourner au lobby",
            letter: "Lettre",
            players: "Joueurs",
            scores: "Scores",
            copyCode: "Copier le code",
            copied: "CopiÃ© !",
            allSubmitted: "Tout le monde a soumis â€” Arbitrage commencÃ© !"
        },
        categories: {
            fa: { name: "Ø§Ø³Ù…", family: "ÙØ§Ù…ÛŒÙ„", city: "Ø´Ù‡Ø±", country: "Ú©Ø´ÙˆØ±", animal: "Ø­ÛŒÙˆØ§Ù†", food: "ØºØ°Ø§", fruit: "Ù…ÛŒÙˆÙ‡", object: "Ø§Ø´ÛŒØ§Ø¡", color: "Ø±Ù†Ú¯", job: "Ø´ØºÙ„" },
            en: { name: "Name", family: "Family", city: "City", country: "Country", animal: "Animal", food: "Food", fruit: "Fruit", object: "Object", color: "Color", job: "Job" },
            fr: { name: "PrÃ©nom", family: "Nom de famille", city: "Ville", country: "Pays", animal: "Animal", food: "Nourriture", fruit: "Fruit", object: "Objet", color: "Couleur", job: "MÃ©tier" }
        }
    };

    let currentCode = null;
    let timerInterval = null;
    let currentLang = 'fa';

    const $ = id => document.getElementById(id);
    const t = key => i18n[currentLang][key] || i18n.fa[key] || key;
    const catT = cat => i18n.categories[currentLang][cat] || i18n.categories.fa[cat] || cat;

    function updateLanguage() {
        currentLang = $('langSelect').value;
        document.documentElement.lang = currentLang === 'fa' ? 'fa' : currentLang;
        document.documentElement.dir = currentLang === 'fa' ? 'rtl' : 'ltr';

        $('title').innerText = t('title');
        $('nameInput').placeholder = t('namePlaceholder');
        $('createBtn').innerText = t('createRoom');
        $('joinBtn').innerText = t('joinRoom');
        $('codeInput').placeholder = t('roomCode');
        $('startBtn').innerText = t('startRound');
        $('submitBtn').innerText = t('submitWords');
        $('reviewTitle').innerText = t('reviewTitle');
        $('finishReviewBtn').innerText = t('finishReview');
        $('copyCodeBtn').innerText = t('copyCode');
    }

    $('langSelect').onchange = updateLanguage;

    $('createBtn').onclick = () => socket.emit("room:create", { name: $('nameInput').value.trim() || "Player" });
    $('joinBtn').onclick = () => {
        const code = $('codeInput').value.trim().toUpperCase();
        if (!code) return alert("Ú©Ø¯ Ø§ØªØ§Ù‚ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
        socket.emit("room:join", { code, name: $('nameInput').value.trim() || "Player" });
    };

    $('startBtn').onclick = () => socket.emit("round:start", { code: currentCode, durationSec: $('durationInput').value });
    $('submitBtn').onclick = submitAnswers;
    $('finishReviewBtn').onclick = () => socket.emit("round:finish_review", { code: currentCode });

    $('copyCodeBtn').onclick = () => {
        navigator.clipboard.writeText(currentCode);
        const btn = $('copyCodeBtn');
        const old = btn.innerText;
        btn.innerText = t('copied');
        setTimeout(() => btn.innerText = old, 1500);
    };

    function submitAnswers() {
        const answers = {};
        document.querySelectorAll('.ans-inp').forEach(i => {
            answers[i.dataset.cat] = i.value.trim();
        });
        socket.emit("submit", { code: currentCode, answers }, () => {
            $('submitBtn').disabled = true;
            $('submitBtn').innerText = t('submitted');
            $('submitBtn').classList.remove('btn-p');
            $('submitBtn').classList.add('btn-success');
        });
    }

    socket.on("room:state", state => {
        currentCode = state.code;
        updateLanguage();

        $('authBox').style.display = 'none';
        $('gameInfo').style.display = 'block';
        $('roomPill').innerText = `${t('roomCode')}: ${state.code}`;
        $('playersCount').innerText = `${t('players')}: ${state.players.length}`;
        $('copyCodeBtn').style.display = 'inline-block';

        const isHost = state.hostSocketId === socket.id;
        $('hostControls').style.display = isHost ? 'block' : 'none';
        $('finishReviewBtn').style.display = (isHost && state.status === 'review') ? 'block' : 'none';

        $('playArea').style.display = state.status === 'playing' ? 'block' : 'none';
        $('reviewArea').style.display = state.status === 'review' ? 'block' : 'none';
        $('statusBadge').innerText = state.status.toUpperCase();

        if (state.status === 'playing') {
            $('letterBox').innerText = state.letter;
            renderFields();
            startTimerUI(state.endsAt, state.durationSec);
            $('submitBtn').disabled = false;
            $('submitBtn').innerText = t('submitWords');
            $('submitBtn').classList.add('btn-p');
            $('submitBtn').classList.remove('btn-success');
        }

        if (state.status === 'review') renderReviewTable(state, isHost);

        renderScores(state.totals, state.players);
        renderPlayerStatus(state);
    });

    function autoResize(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = textarea.scrollHeight + 'px';
    }

    function renderFields() {
        const grid = $('inputsGrid');
        if (grid.children.length > 0) return;
        grid.innerHTML = CATEGORIES.map(cat => `
            <div class="field-card">
                <label>${catT(cat)}</label>
                <textarea class="ans-inp" data-cat="${cat}" oninput="autoResize(this)"></textarea>
            </div>
        `).join('');
        document.querySelectorAll('.ans-inp').forEach(el => el.addEventListener('input', () => autoResize(el)));
    }

    function startTimerUI(endsAt, total) {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            const left = Math.max(0, Math.floor((endsAt - Date.now()) / 1000));
            $('timerText').innerText = left + "s";
            const percent = (left / total) * 100;
            const progress = $('timerProgress');
            progress.style.width = percent + "%";
            progress.classList.toggle('low', left <= 30);
            if (left <= 0) clearInterval(timerInterval);
        }, 500);
    }

    function renderScores(totals, players) {
        const names = new Map(players.map(p => [p.id, p.name]));
        const sorted = totals.sort((a,b) => b.score - a.score);
        $('scoresList').innerHTML = `<b>${t('scores')}:</b>` + 
            (sorted.length ? sorted.map(t => `<div class="score-row"><span>${names.get(t.id)}</span><b>${t.score}</b></div>`).join('') : '<div style="color:#999;padding:10px">Ù‡Ù†ÙˆØ² Ø§Ù…ØªÛŒØ§Ø²ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</div>');
    }

    function renderPlayerStatus(state) {
        const submittedCount = state.submissions.length;
        const totalPlayers = state.players.length;
        if (state.status === 'playing') {
            $('playerStatus').innerText = `${submittedCount} Ø§Ø² ${totalPlayers} Ù†ÙØ± Ú©Ù„Ù…Ø§Øª Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ø±Ø¯Ù‡â€ŒØ§Ù†Ø¯`;
        } else {
            $('playerStatus').innerText = '';
        }
    }

    function renderReviewTable(state, isHost) {
        const header = $('tableHeader');
        const body = $('tableBody');

        header.innerHTML = `<th>Ø¨Ø§Ø²ÛŒÚ©Ù†</th>` + 
            state.categories.map(c => `<th>${catT(c)}</th>`).join('') + 
            `<th>${t('scores')} Ø±Ø§Ù†Ø¯</th>` +
            (isHost ? `<th>Ø§Ù…ØªÛŒØ§Ø²Ø¯Ù‡ÛŒ</th>` : '');

        body.innerHTML = state.submissions.map(sub => {
            const roundScore = sub.roundScore || 0;
            return `
                <tr>
                    <td><b>${sub.name}</b></td>
                    ${state.categories.map(c => `<td>${sub.answers[c] || '-'}</td>`).join('')}
                    <td class="round-total">${roundScore}</td>
                    ${isHost ? `<td>
                        ${state.categories.map(c => `
                            <button class="points-btn btn-0" onclick="assign('${sub.id}','${c}',0)">0</button>
                            <button class="points-btn btn-5" onclick="assign('${sub.id}','${c}',5)">5</button>
                            <button class="points-btn btn-10" onclick="assign('${sub.id}','${c}',10)">10</button>
                        `).join('')}
                    </td>` : ''}
                </tr>
            `;
        }).join('');
    }

    window.assign = (playerId, category, points) => {
        socket.emit("host:assign_score", { code: currentCode, playerId, category, points });
    };

    // Ø´Ø±ÙˆØ¹ Ø§ÙˆÙ„ÛŒÙ‡
    updateLanguage();
</script>
</body>
</html>

<!doctype html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ø§Ø³Ù… ÙØ§Ù…ÛŒÙ„ Ù¾Ø±Ùˆ ğŸ®</title>
    <style>
        :root {
            --primary: #4f46e5;
            --secondary: #6366f1;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --danger: #ef4444;
            --success: #22c55e;
        }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: var(--bg);
            margin: 0;
            color: #1e293b;
        }
        .wrap { max-width: 800px; margin: 0 auto; padding: 20px; }
        
        /* Glassmorphism Cards */
        .card {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 24px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.7);
        }

        .header { text-align: center; margin-bottom: 30px; }
        h1 { font-size: 28px; margin: 0; background: linear-gradient(to right, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .input-group { display: grid; gap: 12px; margin-bottom: 20px; grid-template-columns: 1fr 1fr; }
        @media (max-width: 500px) { .input-group { grid-template-columns: 1fr; } }

        input, select {
            padding: 14px;
            border-radius: 14px;
            border: 2px solid #e2e8f0;
            font-size: 15px;
            transition: 0.3s;
            outline: none;
        }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }

        button {
            padding: 14px 24px;
            border-radius: 14px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
            font-size: 15px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--secondary); transform: translateY(-2px); }
        .btn-primary:disabled { background: #cbd5e1; cursor: not-allowed; }
        .btn-danger { background: #fee2e2; color: var(--danger); }

        /* Timer UI */
        .timer-container {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 10px;
            margin: 15px 0;
            overflow: hidden;
        }
        .timer-bar {
            height: 100%;
            width: 100%;
            background: var(--primary);
            transition: width 1s linear, background-color 0.3s;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 99px;
            font-size: 12px;
            font-weight: 800;
            text-transform: uppercase;
        }
        .status-lobby { background: #f1f5ff; color: var(--primary); }
        .status-playing { background: #fef2f2; color: var(--danger); }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .field-card {
            background: #f1f5f9;
            padding: 12px;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
        }
        .field-card label { display: block; font-size: 12px; font-weight: 700; margin-bottom: 8px; color: #64748b; }
        .field-card input { width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #cbd5e1; }

        .score-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f1f5f9; }
        .score-item:last-child { border-bottom: none; }
        
        .floating-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .pill { background: #fff; padding: 8px 16px; border-radius: 99px; font-size: 13px; font-weight: 700; border: 1px solid #e2e8f0; }
    </style>
</head>
<body>

<div class="wrap">
    <div class="header">
        <h1 id="t-title">Ø§Ø³Ù… Ùˆ ÙØ§Ù…ÛŒÙ„ Ù¾Ø±Ùˆ</h1>
        <p id="t-sub" style="color: #64748b;">ØªØ¬Ø±Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ Ù…Ø¯Ø±Ù† Ùˆ Ø³Ø±ÛŒØ¹</p>
    </div>

    <div class="card" id="authBox">
        <div class="input-group">
            <input id="nameInput" placeholder="Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ" />
            <select id="langSelect">
                <option value="fa">ÙØ§Ø±Ø³ÛŒ</option>
                <option value="en">English</option>
            </select>
        </div>
        <div class="input-group">
            <button class="btn-primary" id="createBtn">Ø³Ø§Ø®Øª Ø§ØªØ§Ù‚ Ø¬Ø¯ÛŒØ¯</button>
            <input id="codeInput" placeholder="Ú©Ø¯ Ø§ØªØ§Ù‚ Ûµ Ø±Ù‚Ù…ÛŒ" style="text-transform: uppercase;" />
        </div>
        <button class="btn-primary" id="joinBtn" style="width: 100%; margin-top: 10px;">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø§ØªØ§Ù‚</button>
    </div>

    <div class="card" id="gameInfo" style="display: none;">
        <div class="floating-info">
            <div id="roomPill" class="pill">Ø§ØªØ§Ù‚: â€”</div>
            <div id="statusBadge" class="status-badge status-lobby">Lobby</div>
        </div>
        
        <div id="hostControls" style="display: none;">
            <div class="input-group">
                <input id="durationInput" type="number" value="120" placeholder="Ø²Ù…Ø§Ù†" />
                <button class="btn-primary" id="startBtn">Ø´Ø±ÙˆØ¹ Ø±Ø§Ù†Ø¯</button>
            </div>
        </div>

        <div id="scoreboard">
            <h3 id="t-scores" style="margin: 15px 0 10px;">Ø§Ù…ØªÛŒØ§Ø²Ø§Øª Ø¨Ø±ØªØ±</h3>
            <div id="scoresList"></div>
        </div>
    </div>

    <div class="card" id="playArea" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="font-size: 24px; font-weight: 900;">Ø­Ø±Ù: <span id="letterBox" style="color: var(--primary);">ØŸ</span></div>
            <div id="timerText" style="font-weight: 800; font-size: 20px;">120s</div>
        </div>
        
        <div class="timer-container">
            <div id="timerBar" class="timer-bar"></div>
        </div>

        <div id="inputsGrid" class="grid" style="margin-top: 20px;"></div>
        
        <button class="btn-primary" id="submitBtn" style="width: 100%; margin-top: 20px; padding: 18px;">Ø§Ø±Ø³Ø§Ù„ Ù†Ù‡Ø§ÛŒÛŒ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§</button>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const CATEGORIES = ["name","family","city","country","animal","food","fruit","object","color","job"];
    const i18n = {
        fa: { name: "Ø§Ø³Ù…", family: "ÙØ§Ù…ÛŒÙ„", city: "Ø´Ù‡Ø±", country: "Ú©Ø´ÙˆØ±", animal: "Ø­ÛŒÙˆØ§Ù†", food: "ØºØ°Ø§", fruit: "Ù…ÛŒÙˆÙ‡", object: "Ø§Ø´ÛŒØ§Ø¡", color: "Ø±Ù†Ú¯", job: "Ø´ØºÙ„" },
        en: { name: "Name", family: "Family", city: "City", country: "Country", animal: "Animal", food: "Food", fruit: "Fruit", object: "Object", color: "Color", job: "Job" }
    };

    let currentCode = null;
    let roomState = null;
    let timerInterval = null;

    const $ = id => document.getElementById(id);

    // Actions
    $('createBtn').onclick = () => {
        const name = $('nameInput').value || "Player";
        socket.emit("room:create", { name }, res => { if(res.ok) currentCode = res.code; });
    };

    $('joinBtn').onclick = () => {
        const name = $('nameInput').value || "Player";
        const code = $('codeInput').value.toUpperCase();
        socket.emit("room:join", { code, name }, res => { if(res.ok) currentCode = res.code; else alert("Ø§ØªØ§Ù‚ ÛŒØ§ÙØª Ù†Ø´Ø¯"); });
    };

    $('startBtn').onclick = () => {
        socket.emit("round:start", { code: currentCode, durationSec: $('durationInput').value });
    };

    $('submitBtn').onclick = () => {
        const answers = {};
        document.querySelectorAll('.ans-inp').forEach(i => answers[i.dataset.cat] = i.value);
        socket.emit("submit", { code: currentCode, answers }, () => {
            $('submitBtn').disabled = true;
            $('submitBtn').innerText = "Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ØŒ Ù…Ù†ØªØ¸Ø± Ø¨Ù‚ÛŒÙ‡...";
        });
    };

    socket.on("room:state", state => {
        roomState = state;
        currentCode = state.code;
        
        $('authBox').style.display = 'none';
        $('gameInfo').style.display = 'block';
        $('roomPill').innerText = "Ø§ØªØ§Ù‚: " + state.code;
        
        // Host UI
        const isHost = state.hostSocketId === socket.id;
        $('hostControls').style.display = isHost ? 'block' : 'none';

        // Play UI
        const isPlaying = state.status === 'playing';
        $('playArea').style.display = isPlaying ? 'block' : 'none';
        $('statusBadge').innerText = isPlaying ? "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø²ÛŒ" : "Ù„Ø§Ø¨ÛŒ";
        $('statusBadge').className = `status-badge ${isPlaying ? 'status-playing' : 'status-lobby'}`;

        if(isPlaying) {
            $('letterBox').innerText = state.letter;
            renderInputs(state.categories);
            handleTimer(state.endsAt, state.durationSec);
            $('submitBtn').disabled = false;
            $('submitBtn').innerText = "Ø§Ø±Ø³Ø§Ù„ Ù†Ù‡Ø§ÛŒÛŒ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§";
        } else {
            clearInterval(timerInterval);
        }

        renderScores(state.totals, state.players);
    });

    function renderInputs(cats) {
        const grid = $('inputsGrid');
        if (grid.children.length > 0) return;
        const lang = $('langSelect').value;
        grid.innerHTML = cats.map(cat => `
            <div class="field-card">
                <label>${i18n[lang][cat] || cat}</label>
                <input class="ans-inp" data-cat="${cat}" placeholder="..." />
            </div>
        `).join('');
    }

    function handleTimer(endsAt, totalSec) {
        clearInterval(timerInterval);
        const bar = $('timerBar');
        const text = $('timerText');

        timerInterval = setInterval(() => {
            const now = Date.now();
            const left = Math.max(0, Math.floor((endsAt - now) / 1000));
            const percent = (left / totalSec) * 100;
            
            bar.style.width = percent + "%";
            text.innerText = left + "s";

            if (percent < 20) bar.style.backgroundColor = 'var(--danger)';
            else bar.style.backgroundColor = 'var(--primary)';

            if (left <= 0) clearInterval(timerInterval);
        }, 1000);
    }

    function renderScores(totals, players) {
        const names = new Map(players.map(p => [p.id, p.name]));
        $('scoresList').innerHTML = totals
            .sort((a,b) => b.score - a.score)
            .map(t => `
                <div class="score-item">
                    <span>${names.get(t.id) || 'Player'}</span>
                    <strong>${t.score} Ø§Ù…ØªÛŒØ§Ø²</strong>
                </div>
            `).join('');
    }
</script>

</body>
</html>

<!doctype html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ø§Ø³Ù… ÙØ§Ù…ÛŒÙ„ Ø¢Ù†Ù„Ø§ÛŒÙ†</title>
    <style>
        :root { --p: #4f46e5; --bg: #f8fafc; --danger: #ef4444; }
        body { font-family: system-ui; background: var(--bg); margin: 0; padding: 15px; }
        .wrap { max-width: 800px; margin: 0 auto; }
        .card { background: #fff; border-radius: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h1 { font-size: 22px; text-align: center; color: var(--p); }

        /* ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ Ø¬Ø°Ø§Ø¨ */
        #authBox { animation: fadeIn 0.8s ease-out; text-align: center; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        #welcomeText { color:#64748b; font-size:15px; margin:10px 0 20px; animation: fadeIn 1s ease-out 0.3s both; }

        .input-group { display: grid; gap: 10px; margin-bottom: 15px; grid-template-columns: 1fr 1fr; }
        input, select, button { padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 14px; }
        input:focus, select:focus { outline: none; border-color: var(--p); box-shadow: 0 0 0 3px rgba(79,70,229,0.2); }
        button { cursor: pointer; font-weight: bold; transition: 0.2s; border: none; }
        .btn-p { background: var(--p); color: white; }
        .btn-p:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(79,70,229,0.3); }

        .timer-bar { height: 6px; background: #e2e8f0; border-radius: 10px; margin: 10px 0; overflow: hidden; }
        .timer-progress { height: 100%; background: var(--p); width: 100%; transition: width 1s linear; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .field-card { background: #f1f5f9; padding: 10px; border-radius: 12px; min-height: 60px; display: flex; flex-direction: column; }
        .field-card label { font-size: 11px; font-weight: bold; margin-bottom: 5px; }
        .field-card input { flex-grow: 1; border:none; background:transparent; font-size:14px; }

        .score-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f5f9; }
        .player-status { font-size: 12px; color: #64748b; }

        /* Ø¬Ø¯ÙˆÙ„ Ø¯Ø§ÙˆØ±ÛŒ */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        th, td { border: 1px solid #e2e8f0; padding: 8px; text-align: center; vertical-align: top; }
        th { background: #f8fafc; }
        .points-btn {
            padding: 6px 10px; font-size: 11px; margin: 2px; border-radius: 8px;
            background: #e2e8f0; color: #334155; border: none; cursor: pointer;
            min-width: 32px; font-weight: bold;
        }
        .points-btn.selected { background: var(--p); color: white; box-shadow: 0 2px 8px rgba(79,70,229,0.3); }
        .points-btn:hover:not(.selected) { background: #cbd5e1; }
        .total-score { font-weight: bold; background: #eef2ff; }

        #copyCodeBtn { position:absolute; right:4px; top:4px; padding:8px 12px; font-size:12px; border-radius:8px; background:#e2e8f0; border:none; cursor:pointer; }
        #copyCodeBtn:hover { background: #cbd5e1; }

        @media (max-width: 600px) {
            .points-btn { padding: 5px 8px; font-size: 10px; min-width: 28px; }
        }
    </style>
</head>
<body>
<div class="wrap">
    <div class="card" id="authBox">
        <div style="text-align:center; margin-bottom: 20px;">
            <h1 id="title" style="font-size:28px; margin-bottom:8px;">ğŸ“ Ø§Ø³Ù… ÙØ§Ù…ÛŒÙ„ Ø¢Ù†Ù„Ø§ÛŒÙ†</h1>
            <p id="welcomeText">Ø¨Ø§ Ø¯ÙˆØ³ØªØ§Ù†Øª Ø±Ù‚Ø§Ø¨Øª Ú©Ù† Ùˆ Ù„Ø°Øª Ø¨Ø¨Ø±!</p>
        </div>

        <div class="input-group">
            <input id="nameInput" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§" />
            <select id="langSelect">
                <option value="fa">ÙØ§Ø±Ø³ÛŒ</option>
                <option value="en">English</option>
                <option value="fr">FranÃ§ais</option>
            </select>
        </div>

        <div class="input-group">
            <button class="btn-p" id="createBtn">Ø³Ø§Ø®Øª Ø§ØªØ§Ù‚ Ø¬Ø¯ÛŒØ¯</button>
            <div style="position:relative;">
                <input id="codeInput" placeholder="Ú©Ø¯ Ø§ØªØ§Ù‚ (Ù…Ø«Ø§Ù„: ABC12)" style="padding-right:60px;" />
                <button id="copyCodeBtn">Ú©Ù¾ÛŒ</button>
            </div>
        </div>

        <button class="btn-p" id="joinBtn" style="width:100%; margin-top:10px; padding:14px; font-size:16px;">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø§ØªØ§Ù‚</button>

        <p style="text-align:center; margin-top:20px; font-size:12px; color:#94a3b8;">
            Ù†Ø³Ø®Ù‡ Ø¯Ø§ÙˆØ±ÛŒ Ø¯Ø³ØªÛŒ â€¢ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ø¨Ø§ â¤ï¸
        </p>
    </div>

    <div class="card" id="gameInfo" style="display:none">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <div id="roomPill" style="font-weight:bold">Ø§ØªØ§Ù‚: â€”</div>
            <div id="statusBadge" style="color:var(--p); font-size:12px">Lobby</div>
        </div>
        <div id="playerCount" style="font-size:12px; margin-top:5px">Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†: 0</div>
        <div id="hostControls" style="display:none; margin-top:10px">
            <input id="durationInput" type="number" value="120" style="width:70px" />
            <button class="btn-p" id="startBtn">Ø´Ø±ÙˆØ¹ Ø±Ø§Ù†Ø¯</button>
        </div>
        <div id="scoresList" style="margin-top:15px"></div>
    </div>

    <div class="card" id="playArea" style="display:none">
        <div style="display:flex; justify-content:space-between">
            <div style="font-weight:bold" id="letterLabel">Ø­Ø±Ù: <span id="letterBox" style="color:var(--p)">ØŸ</span></div>
            <div id="timerText">120s</div>
        </div>
        <div class="timer-bar"><div id="timerProgress" class="timer-progress"></div></div>
        <div id="inputsGrid" class="grid"></div>
        <button class="btn-p" id="submitBtn" style="width:100%; margin-top:15px">Ø§Ø±Ø³Ø§Ù„ Ú©Ù„Ù…Ø§Øª</button>
    </div>

    <div class="card" id="reviewArea" style="display:none">
        <h2 id="reviewTitle" style="font-size:16px">ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù„Ù…Ø§Øª (Ù…Ø®ØµÙˆØµ Ù…ÛŒØ²Ø¨Ø§Ù†)</h2>
        <div style="overflow-x:auto">
            <table id="reviewTable">
                <thead><tr id="tableHeader"></tr></thead>
                <tbody id="tableBody"></tbody>
                <tfoot id="tableFooter"></tfoot>
            </table>
        </div>
        <button id="finishReviewBtn" class="btn-p" style="width:100%; margin-top:15px; display:none">Ù¾Ø§ÛŒØ§Ù† Ø¯Ø§ÙˆØ±ÛŒ Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„Ø§Ø¨ÛŒ</button>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const CATEGORIES = ["name","family","city","country","animal","food","fruit","object","color","job"];

    const i18n = {
        fa: { categories: { name: "Ø§Ø³Ù…", family: "ÙØ§Ù…ÛŒÙ„", city: "Ø´Ù‡Ø±", country: "Ú©Ø´ÙˆØ±", animal: "Ø­ÛŒÙˆØ§Ù†", food: "ØºØ°Ø§", fruit: "Ù…ÛŒÙˆÙ‡", object: "Ø§Ø´ÛŒØ§Ø¡", color: "Ø±Ù†Ú¯", job: "Ø´ØºÙ„" },
              ui: { title: "ğŸ“ Ø§Ø³Ù… ÙØ§Ù…ÛŒÙ„ Ø¢Ù†Ù„Ø§ÛŒÙ†", welcome: "Ø¨Ø§ Ø¯ÙˆØ³ØªØ§Ù†Øª Ø±Ù‚Ø§Ø¨Øª Ú©Ù† Ùˆ Ù„Ø°Øª Ø¨Ø¨Ø±!", namePlaceholder: "Ù†Ø§Ù… Ø´Ù…Ø§", codePlaceholder: "Ú©Ø¯ Ø§ØªØ§Ù‚ (Ù…Ø«Ø§Ù„: ABC12)", createBtn: "Ø³Ø§Ø®Øª Ø§ØªØ§Ù‚ Ø¬Ø¯ÛŒØ¯", joinBtn: "ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø§ØªØ§Ù‚", startBtn: "Ø´Ø±ÙˆØ¹ Ø±Ø§Ù†Ø¯", submitBtn: "Ø§Ø±Ø³Ø§Ù„ Ú©Ù„Ù…Ø§Øª", submitted: "Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ âœ“", reviewTitle: "ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù„Ù…Ø§Øª (Ù…Ø®ØµÙˆØµ Ù…ÛŒØ²Ø¨Ø§Ù†)", finishReviewBtn: "Ù¾Ø§ÛŒØ§Ù† Ø¯Ø§ÙˆØ±ÛŒ Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„Ø§Ø¨ÛŒ", room: "Ø§ØªØ§Ù‚", letter: "Ø­Ø±Ù", scores: "Ø§Ù…ØªÛŒØ§Ø²Ø§Øª Ú©Ù„", players: "Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†", waiting: "Ø¯Ø± Ù„Ø§Ø¨ÛŒ", writing: "Ø¯Ø± Ø­Ø§Ù„ Ù†ÙˆØ´ØªÙ†", submittedStatus: "Ø§Ø±Ø³Ø§Ù„ Ú©Ø±Ø¯Ù‡" } },
        en: { categories: { name: "Name", family: "Family", city: "City", country: "Country", animal: "Animal", food: "Food", fruit: "Fruit", object: "Object", color: "Color", job: "Job" },
              ui: { title: "ğŸ“ Name Family Online", welcome: "Play with friends and have fun!", namePlaceholder: "Your Name", codePlaceholder: "Room Code (e.g. ABC12)", createBtn: "Create Room", joinBtn: "Join Room", startBtn: "Start Round", submitBtn: "Submit Words", submitted: "Submitted âœ“", reviewTitle: "ğŸ” Review Words (Host Only)", finishReviewBtn: "End Review & Back to Lobby", room: "Room", letter: "Letter", scores: "Total Scores", players: "Players", waiting: "In lobby", writing: "Writing", submittedStatus: "Submitted" } },
        fr: { categories: { name: "PrÃ©nom", family: "Nom de famille", city: "Ville", country: "Pays", animal: "Animal", food: "Nourriture", fruit: "Fruit", object: "Objet", color: "Couleur", job: "MÃ©tier" },
              ui: { title: "ğŸ“ Petit Bac En Ligne", welcome: "Jouez avec vos amis et amusez-vous !", namePlaceholder: "Votre Nom", codePlaceholder: "Code Salle (ex: ABC12)", createBtn: "CrÃ©er une Salle", joinBtn: "Entrer", startBtn: "DÃ©marrer le Tour", submitBtn: "Soumettre les Mots", submitted: "Soumis âœ“", reviewTitle: "ğŸ” Examen des Mots (HÃ´te)", finishReviewBtn: "Terminer & Retour au Lobby", room: "Salle", letter: "Lettre", scores: "Scores Totaux", players: "Joueurs", waiting: "Dans le lobby", writing: "En Ã©criture", submittedStatus: "Soumis" } }
    };

    let currentCode = null;
    let timerInterval = null;
    let lang = 'fa';
    const $ = id => document.getElementById(id);

    function updateUI() {
        const t = i18n[lang].ui;
        $('title').innerText = t.title;
        $('welcomeText').innerText = t.welcome;
        $('nameInput').placeholder = t.namePlaceholder;
        $('codeInput').placeholder = t.codePlaceholder;
        $('createBtn').innerText = t.createBtn;
        $('joinBtn').innerText = t.joinBtn;
        $('startBtn').innerText = t.startBtn;
        $('reviewTitle').innerText = t.reviewTitle;
        $('finishReviewBtn').innerText = t.finishReviewBtn;
        $('letterLabel').innerHTML = `${t.letter}: <span id="letterBox" style="color:var(--p)">ØŸ</span>`;
        if (currentCode) $('roomPill').innerText = `${t.room}: ${currentCode}`;
    }

    $('langSelect').onchange = () => {
        lang = $('langSelect').value;
        document.documentElement.lang = lang;
        document.documentElement.dir = lang === 'fa' ? 'rtl' : 'ltr';
        updateUI();
        if ($('inputsGrid').children.length > 0) renderFields(CATEGORIES); // ÙÙ‚Ø· Ø§Ú¯Ø± ÙÛŒÙ„Ø¯Ù‡Ø§ Ù‡Ø³ØªÙ†ØŒ Ù„ÛŒØ¨Ù„â€ŒÙ‡Ø§ Ø±Ùˆ Ø¢Ù¾Ø¯ÛŒØª Ú©Ù†
        if ($('reviewArea').style.display !== 'none') renderReviewTable(window.lastState, window.lastIsHost);
        renderScores(window.lastTotals || [], window.lastPlayers || []);
    };

    $('copyCodeBtn').onclick = () => {
        const code = $('codeInput').value.trim().toUpperCase();
        if (code) {
            navigator.clipboard.writeText(code);
            const btn = $('copyCodeBtn');
            const old = btn.innerText;
            btn.innerText = lang === 'fa' ? 'Ú©Ù¾ÛŒ Ø´Ø¯!' : lang === 'en' ? 'Copied!' : 'CopiÃ© !';
            btn.style.background = '#86efac';
            setTimeout(() => { btn.innerText = old; btn.style.background = '#e2e8f0'; }, 1500);
        }
    };

    $('createBtn').onclick = () => socket.emit("room:create", { name: $('nameInput').value || "Ø¨Ø§Ø²ÛŒÚ©Ù†", lang });
    $('joinBtn').onclick = () => socket.emit("room:join", { code: $('codeInput').value.toUpperCase().trim(), name: $('nameInput').value || "Ø¨Ø§Ø²ÛŒÚ©Ù†", lang });
    $('startBtn').onclick = () => socket.emit("round:start", { code: currentCode, durationSec: $('durationInput').value });
    $('submitBtn').onclick = () => {
        const answers = {};
        document.querySelectorAll('.ans-inp').forEach(i => answers[i.dataset.cat] = i.value.trim());
        socket.emit("submit", { code: currentCode, answers }, () => {
            $('submitBtn').disabled = true;
            $('submitBtn').innerText = i18n[lang].ui.submitted;
        });
    };
    $('finishReviewBtn').onclick = () => socket.emit("round:finish_review", { code: currentCode });

    socket.on("room:state", state => {
        currentCode = state.code;
        $('authBox').style.display = 'none';
        $('gameInfo').style.display = 'block';

        const t = i18n[lang].ui;
        $('roomPill').innerText = `${t.room}: ${state.code}`;
        const isHost = state.hostSocketId === socket.id;
        $('hostControls').style.display = isHost ? 'block' : 'none';
        $('finishReviewBtn').style.display = (isHost && state.status === 'review') ? 'block' : 'none';

        $('playArea').style.display = state.status === 'playing' ? 'block' : 'none';
        $('reviewArea').style.display = state.status === 'review' ? 'block' : 'none';
        $('statusBadge').innerText = state.status.toUpperCase();
        $('playerCount').innerText = `${t.players}: ${state.players.length}`;

        if (state.status === 'playing') {
            $('letterBox').innerText = state.letter;

            // ÙÙ‚Ø· ÛŒÚ© Ø¨Ø§Ø± ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ùˆ Ø¨Ø³Ø§Ø² (ÙˆÙ‚ØªÛŒ grid Ø®Ø§Ù„ÛŒÙ‡)
            if ($('inputsGrid').children.length === 0) {
                renderFields(state.categories);
            }

            startTimerUI(state.endsAt, state.durationSec);

            // ÙˆØ¶Ø¹ÛŒØª Ø¯Ú©Ù…Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ¯Ù…ÙˆÙ†
            const myPlayer = state.players.find(p => p.id === socket.id);
            if (myPlayer && myPlayer.status === 'submitted') {
                $('submitBtn').disabled = true;
                $('submitBtn').innerText = t.submitted;
            } else {
                $('submitBtn').disabled = false;
                $('submitBtn').innerText = t.submitBtn;
            }
        }

        if (state.status === 'review') {
            window.lastState = state;
            window.lastIsHost = isHost;
            renderReviewTable(state, isHost);
        }

        if (state.status === 'lobby' || state.status === 'review') {
            $('inputsGrid').innerHTML = '';
        }

        window.lastTotals = state.totals;
        window.lastPlayers = state.players;
        renderScores(state.totals, state.players);
    });

    function renderFields(cats) {
        const grid = $('inputsGrid');
        grid.innerHTML = '';
        const labels = i18n[lang].categories;
        cats.forEach(cat => {
            const div = document.createElement('div');
            div.className = 'field-card';
            div.innerHTML = `<label>${labels[cat] || cat}</label><input class="ans-inp" data-cat="${cat}" value="" autocomplete="off" />`;
            grid.appendChild(div);
        });
    }

    function startTimerUI(endsAt, total) {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            const left = Math.max(0, Math.floor((endsAt - Date.now()) / 1000));
            $('timerText').innerText = left + "s";
            $('timerProgress').style.width = (left / total * 100) + "%";
            if (left <= 0) clearInterval(timerInterval);
        }, 1000);
    }

    function renderScores(totals, players) {
        const t = i18n[lang].ui;
        const names = new Map(players.map(p => [p.id, p.name]));
        const statusMap = new Map(players.map(p => [p.id, p.status === 'submitted' ? t.submittedStatus : p.status === 'writing' ? t.writing : t.waiting]));
        let html = `<b>${t.scores}:</b>`;
        totals.sort((a,b) => b.score - a.score).forEach(item => {
            html += `<div class="score-row"><span>${names.get(item.id)} <span class="player-status">(${statusMap.get(item.id)})</span></span><b>${item.score}</b></div>`;
        });
        $('scoresList').innerHTML = html;
    }

    function renderReviewTable(state, isHost) {
        const labels = i18n[lang].categories;
        const header = $('tableHeader');
        const body = $('tableBody');

        let headerHtml = '<th>Ø¨Ø§Ø²ÛŒÚ©Ù†</th>' +
                         state.categories.map(c => `<th>${labels[c] || c}</th>`).join('') +
                         '<th class="total-score">Ù…Ø¬Ù…ÙˆØ¹ Ø±Ø§Ù†Ø¯</th>';
        header.innerHTML = headerHtml;

        body.innerHTML = state.submissions.map(sub => {
            const rowSum = Object.values(sub.scores || {}).reduce((a,b) => a + b, 0);
            let row = `<tr><td><b>${sub.name}</b></td>`;

            state.categories.forEach(c => {
                const answer = sub.answers[c] || '-';
                const score = sub.scores[c] || 0;
                let cell = `<div style="margin-bottom:8px; font-weight:500;">${answer}</div>`;

                if (isHost) {
                    cell += `<div style="display:flex; justify-content:center; gap:4px; flex-wrap:wrap;">`;
                    [0, 5, 10].forEach(pts => {
                        const selected = score === pts ? 'selected' : '';
                        cell += `<button class="points-btn ${selected}" onclick="assign('${sub.id}','${c}',${pts})">${pts}</button>`;
                    });
                    cell += `</div>`;
                } else {
                    cell += `<div style="font-size:12px; color:#64748b;">(${score} Ø§Ù…ØªÛŒØ§Ø²)</div>`;
                }

                row += `<td style="padding:10px 6px;">${cell}</td>`;
            });

            row += `<td class="total-score"><b>${rowSum}</b></td></tr>`;
            return row;
        }).join('');
    }

    window.assign = (pid, cat, pts) => {
        socket.emit("host:assign_score", { code: currentCode, playerId: pid, category: cat, points: pts });
    };

    // Ø´Ø±ÙˆØ¹ Ø§ÙˆÙ„ÛŒÙ‡
    updateUI();
</script>
</body>
</html>

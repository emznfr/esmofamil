<!doctype html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ø§Ø³Ù… ÙØ§Ù…ÛŒÙ„ Ø¢Ù†Ù„Ø§ÛŒÙ†</title>
    <style>
        :root { --p: #4f46e5; --bg: #f8fafc; --danger: #ef4444; }
        body { font-family: system-ui; background: var(--bg); margin: 0; padding: 15px; }
        .wrap { max-width: 800px; margin: 0 auto; }
        .card { background: #fff; border-radius: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h1 { font-size: 22px; text-align: center; color: var(--p); }
        .input-group { display: grid; gap: 10px; margin-bottom: 15px; grid-template-columns: 1fr 1fr; }
        input, select, button { padding: 12px; border-radius: 12px; border: 1px solid #e2e8f0; font-size: 14px; }
        button { cursor: pointer; font-weight: bold; transition: 0.2s; border: none; }
        .btn-p { background: var(--p); color: white; }
        .timer-bar { height: 6px; background: #e2e8f0; border-radius: 10px; margin: 10px 0; overflow: hidden; }
        .timer-progress { height: 100%; background: var(--p); width: 100%; transition: 1s linear; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; }
        .field-card { background: #f1f5f9; padding: 10px; border-radius: 12px; }
        .field-card label { display: block; font-size: 11px; font-weight: bold; margin-bottom: 5px; }
        .score-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f5f9; }
        
        /* Review Table */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; }
        th, td { border: 1px solid #e2e8f0; padding: 8px; text-align: center; }
        th { background: #f8fafc; }
        .points-btn { padding: 4px 8px; font-size: 10px; margin: 2px; border-radius: 6px; }
    </style>
</head>
<body>

<div class="wrap">
    <div class="card" id="authBox">
        <h1>ğŸ“ Ø§Ø³Ù… ÙØ§Ù…ÛŒÙ„ (Ù†Ø³Ø®Ù‡ Ø¯Ø§ÙˆØ±ÛŒ)</h1>
        <div class="input-group">
            <input id="nameInput" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§" />
            <select id="langSelect"><option value="fa">ÙØ§Ø±Ø³ÛŒ</option><option value="en">English</option></select>
        </div>
        <div class="input-group">
            <button class="btn-p" id="createBtn">Ø³Ø§Ø®Øª Ø§ØªØ§Ù‚</button>
            <input id="codeInput" placeholder="Ú©Ø¯ Ø§ØªØ§Ù‚" />
        </div>
        <button class="btn-p" id="joinBtn" style="width:100%; margin-top:5px">ÙˆØ±ÙˆØ¯</button>
    </div>

    <div class="card" id="gameInfo" style="display:none">
        <div style="display:flex; justify-content:space-between; align-items:center">
            <div id="roomPill" style="font-weight:bold">Ø§ØªØ§Ù‚: â€”</div>
            <div id="statusBadge" style="color:var(--p); font-size:12px">Lobby</div>
        </div>
        <div id="hostControls" style="display:none; margin-top:10px">
            <input id="durationInput" type="number" value="120" style="width:70px" />
            <button class="btn-p" id="startBtn">Ø´Ø±ÙˆØ¹ Ø±Ø§Ù†Ø¯</button>
        </div>
        <div id="scoresList" style="margin-top:15px"></div>
    </div>

    <div class="card" id="playArea" style="display:none">
        <div style="display:flex; justify-content:space-between">
            <div style="font-weight:bold">Ø­Ø±Ù: <span id="letterBox" style="color:var(--p)">ØŸ</span></div>
            <div id="timerText">120s</div>
        </div>
        <div class="timer-bar"><div id="timerProgress" class="timer-progress"></div></div>
        <div id="inputsGrid" class="grid"></div>
        <button class="btn-p" id="submitBtn" style="width:100%; margin-top:15px">Ø§Ø±Ø³Ø§Ù„ Ú©Ù„Ù…Ø§Øª</button>
    </div>

    <div class="card" id="reviewArea" style="display:none">
        <h2 style="font-size:16px">ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù„Ù…Ø§Øª (Ù…Ø®ØµÙˆØµ Ù…ÛŒØ²Ø¨Ø§Ù†)</h2>
        <div style="overflow-x:auto">
            <table id="reviewTable">
                <thead><tr id="tableHeader"></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        <button id="finishReviewBtn" class="btn-p" style="width:100%; margin-top:15px; display:none">Ù¾Ø§ÛŒØ§Ù† Ø¯Ø§ÙˆØ±ÛŒ Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„Ø§Ø¨ÛŒ</button>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const CATEGORIES = ["name","family","city","country","animal","food","fruit","object","color","job"];
    const i18n = { fa: { name: "Ø§Ø³Ù…", family: "ÙØ§Ù…ÛŒÙ„", city: "Ø´Ù‡Ø±", country: "Ú©Ø´ÙˆØ±", animal: "Ø­ÛŒÙˆØ§Ù†", food: "ØºØ°Ø§", fruit: "Ù…ÛŒÙˆÙ‡", object: "Ø§Ø´ÛŒØ§Ø¡", color: "Ø±Ù†Ú¯", job: "Ø´ØºÙ„" }, en: { name: "Name", family: "Family", city: "City", country: "Country", animal: "Animal", food: "Food", fruit: "Fruit", object: "Object", color: "Color", job: "Job" } };

    let currentCode = null;
    let timerInterval = null;

    const $ = id => document.getElementById(id);

    $('createBtn').onclick = () => socket.emit("room:create", { name: $('nameInput').value }, res => { if(res.ok) currentCode = res.code; });
    $('joinBtn').onclick = () => socket.emit("room:join", { code: $('codeInput').value.toUpperCase(), name: $('nameInput').value }, res => { if(res.ok) currentCode = res.code; else alert("Ø§ØªØ§Ù‚ Ù†ÛŒØ³Øª"); });
    $('startBtn').onclick = () => socket.emit("round:start", { code: currentCode, durationSec: $('durationInput').value });
    $('submitBtn').onclick = () => {
        const answers = {};
        document.querySelectorAll('.ans-inp').forEach(i => answers[i.dataset.cat] = i.value);
        socket.emit("submit", { code: currentCode, answers }, () => { $('submitBtn').disabled = true; $('submitBtn').innerText = "ÙØ±Ø³ØªØ§Ø¯Ù‡ Ø´Ø¯"; });
    };
    $('finishReviewBtn').onclick = () => socket.emit("round:finish_review", { code: currentCode });

    socket.on("room:state", state => {
        currentCode = state.code;
        $('authBox').style.display = 'none';
        $('gameInfo').style.display = 'block';
        $('roomPill').innerText = "Ø§ØªØ§Ù‚: " + state.code;
        
        const isHost = state.hostSocketId === socket.id;
        $('hostControls').style.display = isHost ? 'block' : 'none';
        $('finishReviewBtn').style.display = (isHost && state.status === 'review') ? 'block' : 'none';

        // Visibility
        $('playArea').style.display = state.status === 'playing' ? 'block' : 'none';
        $('reviewArea').style.display = state.status === 'review' ? 'block' : 'none';
        $('statusBadge').innerText = state.status.toUpperCase();

        if(state.status === 'playing') {
            $('letterBox').innerText = state.letter;
            renderFields(state.categories);
            startTimerUI(state.endsAt, state.durationSec);
            $('submitBtn').disabled = false;
            $('submitBtn').innerText = "Ø§Ø±Ø³Ø§Ù„ Ú©Ù„Ù…Ø§Øª";
        }

        if(state.status === 'review') renderReviewTable(state, isHost);

        renderScores(state.totals, state.players);
    });

    function renderFields(cats) {
        const grid = $('inputsGrid');
        if (grid.children.length > 0) return;
        const lang = $('langSelect').value;
        grid.innerHTML = cats.map(cat => `<div class="field-card"><label>${i18n[lang][cat] || cat}</label><input class="ans-inp" data-cat="${cat}" /></div>`).join('');
    }

    function startTimerUI(endsAt, total) {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            const left = Math.max(0, Math.floor((endsAt - Date.now()) / 1000));
            $('timerText').innerText = left + "s";
            $('timerProgress').style.width = (left / total * 100) + "%";
            if(left <= 0) clearInterval(timerInterval);
        }, 1000);
    }

    function renderScores(totals, players) {
        const names = new Map(players.map(p => [p.id, p.name]));
        $('scoresList').innerHTML = '<b>Ø§Ù…ØªÛŒØ§Ø²Ø§Øª:</b>' + totals.sort((a,b)=>b.score-a.score).map(t => `<div class="score-row"><span>${names.get(t.id)}</span><b>${t.score}</b></div>`).join('');
    }

    function renderReviewTable(state, isHost) {
        const lang = $('langSelect').value;
        const header = $('tableHeader');
        const body = $('tableBody');
        
        header.innerHTML = '<th>Ø¨Ø§Ø²ÛŒÚ©Ù†</th>' + state.categories.map(c => `<th>${i18n[lang][c] || c}</th>`).join('') + (isHost ? '<th>Ø¹Ù…Ù„ÛŒØ§Øª</th>' : '');
        
        body.innerHTML = state.submissions.map(sub => `
            <tr>
                <td><b>${sub.name}</b></td>
                ${state.categories.map(c => `<td>${sub.answers[c] || '-'}</td>`).join('')}
                ${isHost ? `<td>
                    <button class="points-btn" onclick="assign(${sub.id}, 5)">+5</button>
                    <button class="points-btn" onclick="assign(${sub.id}, 10)">+10</button>
                    <button class="points-btn" onclick="assign(${sub.id}, 20)">+20</button>
                </td>` : ''}
            </tr>
        `).join('');
    }

    window.assign = (pid, pts) => {
        socket.emit("host:assign_score", { code: currentCode, playerId: pid, points: pts });
    };
</script>
</body>
</html>

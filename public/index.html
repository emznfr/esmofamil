<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ø³Ù… Ùˆ ÙØ§Ù…ÛŒÙ„ Ø¢Ù†Ù„Ø§ÛŒÙ†</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:#f6f7fb}
    .wrap{max-width:760px;margin:0 auto;padding:14px}
    .card{background:#fff;border-radius:16px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.06);margin-bottom:12px}
    h1{margin:0 0 6px;font-size:20px}
    .sub{color:#666;font-size:13px;margin-bottom:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1;min-width:140px}
    input,select,button{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #e3e6f0;font-size:14px;box-sizing:border-box}
    button{border:none;background:#2563eb;color:#fff;font-weight:700;cursor:pointer}
    button.secondary{background:#eef2ff;color:#1e3a8a}
    button.danger{background:#ef4444}
    .muted{font-size:12px;color:#6b7280}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#f1f5ff;color:#1e3a8a;font-weight:700;font-size:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}
    label{display:flex;justify-content:space-between;align-items:center;font-size:13px;color:#111827;margin-bottom:6px}
    .scoreRow{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eef2f7}
    .scoreRow:last-child{border-bottom:none}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .timer{font-weight:800}
    .badge{padding:6px 10px;border-radius:10px;background:#f0fdf4;color:#166534;font-weight:800;font-size:12px}
    .badge.red{background:#fef2f2;color:#991b1b}
  </style>
</head>
<body>
<div class="wrap">

  <div class="card">
    <div class="topbar">
      <div>
        <h1 id="appTitle">Ø§Ø³Ù… Ùˆ ÙØ§Ù…ÛŒÙ„ Ø¢Ù†Ù„Ø§ÛŒÙ†</h1>
        <div class="sub" id="appSubtitle">Ø¨Ø§Ø²ÛŒ Ú†Ù†Ø¯Ù†ÙØ±Ù‡ Ø¨Ø§ Ù‡Ù…Ø²Ù…Ø§Ù†ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ ğŸ®</div>
      </div>
      <select id="langSelect" style="max-width:170px">
        <option value="fa">ÙØ§Ø±Ø³ÛŒ</option>
        <option value="en">English</option>
        <option value="fr">FranÃ§ais</option>
      </select>
    </div>
  </div>

  <div class="card" id="scoresBox">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div id="scoresTitle" style="font-weight:900">Ø§Ù…ØªÛŒØ§Ø²Ù‡Ø§</div>
      <div class="pill" id="roomPill">â€”</div>
    </div>
    <div id="scoresList" class="muted">Ù‡Ù†ÙˆØ² Ø§Ù…ØªÛŒØ§Ø²ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</div>
  </div>

  <div class="card" id="lobbyCard">
    <div class="row">
      <input id="nameInput" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§" />
      <input id="codeInput" placeholder="Ú©Ø¯ Ø§ØªØ§Ù‚ (Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯)" />
    </div>
    <div class="row" style="margin-top:10px">
      <button id="createBtn">Ø³Ø§Ø®Øª Ø§ØªØ§Ù‚</button>
      <button id="joinBtn" class="secondary">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø§ØªØ§Ù‚</button>
    </div>

    <div style="margin-top:12px" class="row">
      <div>
        <label><span id="timeLabel">Ø²Ù…Ø§Ù† (Ø«Ø§Ù†ÛŒÙ‡)</span><span class="muted" id="minTimeHint">Ø­Ø¯Ø§Ù‚Ù„ 120</span></label>
        <input id="durationSec" type="number" min="120" value="120" />
      </div>
      <div>
        <label><span>ÙˆØ¶Ø¹ÛŒØª</span><span id="statusBadge" class="badge">Lobby</span></label>
        <div class="row">
          <button id="startRoundBtn">Ø´Ø±ÙˆØ¹ Ø±Ø§Ù†Ø¯ (Ù…ÛŒØ²Ø¨Ø§Ù†)</button>
          <button id="endRoundBtn" class="danger">Ù¾Ø§ÛŒØ§Ù† Ø±Ø§Ù†Ø¯</button>
        </div>
      </div>
    </div>

    <div style="margin-top:10px" class="muted">
      Ù†Ú©ØªÙ‡: Ø§Ù…ØªÛŒØ§Ø²Ø¯Ù‡ÛŒ Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø³Ø§Ø¯Ù‡ Ø§Ø³Øª: Ù¾Ø§Ø³Ø® ØªÚ©Ø±Ø§Ø±ÛŒ (ÛŒÚ©Ø³Ø§Ù†) = 10ØŒ Ù¾Ø§Ø³Ø® ÛŒÚ©ØªØ§ = 20.
    </div>
  </div>

  <div class="card" id="playCard" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div>
        <span class="pill">Round: <span id="roundNum">0</span></span>
        <span class="pill">Ø­Ø±Ù: <span id="letterBox">â€”</span></span>
      </div>
      <div class="timer" id="timerText">â€”</div>
    </div>

    <div id="inputsGrid" class="grid"></div>

    <div class="row" style="margin-top:10px">
      <button id="submitBtn">Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§</button>
      <button id="leaveBtn" class="secondary">Ø®Ø±ÙˆØ¬ Ø§Ø² Ø§ØªØ§Ù‚</button>
    </div>
  </div>

</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  const CATEGORY_KEYS = ["name","family","city","country","animal","food","fruit","object","color","job"];

  const i18n = {
    fa: {
      title: "Ø§Ø³Ù… Ùˆ ÙØ§Ù…ÛŒÙ„ Ø¢Ù†Ù„Ø§ÛŒÙ†",
      subtitle: "Ø¨Ø§Ø²ÛŒ Ú†Ù†Ø¯Ù†ÙØ±Ù‡ Ø¨Ø§ Ù‡Ù…Ø²Ù…Ø§Ù†ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ ğŸ®",
      buttons: {
        create: "Ø³Ø§Ø®Øª Ø§ØªØ§Ù‚",
        join: "ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø§ØªØ§Ù‚",
        start: "Ø´Ø±ÙˆØ¹ Ø±Ø§Ù†Ø¯ (Ù…ÛŒØ²Ø¨Ø§Ù†)",
        end: "Ù¾Ø§ÛŒØ§Ù† Ø±Ø§Ù†Ø¯",
        submit: "Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§",
        leave: "Ø®Ø±ÙˆØ¬ Ø§Ø² Ø§ØªØ§Ù‚"
      },
      placeholders: { name: "Ù†Ø§Ù… Ø´Ù…Ø§", code: "Ú©Ø¯ Ø§ØªØ§Ù‚ (Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯)" },
      categories: {
        name:"Ø§Ø³Ù…", family:"ÙØ§Ù…ÛŒÙ„", city:"Ø´Ù‡Ø±", country:"Ú©Ø´ÙˆØ±", animal:"Ø­ÛŒÙˆØ§Ù†",
        food:"ØºØ°Ø§", fruit:"Ù…ÛŒÙˆÙ‡", object:"Ø§Ø´ÛŒØ§Ø¡", color:"Ø±Ù†Ú¯", job:"Ø´ØºÙ„"
      },
      timeLabel: "Ø²Ù…Ø§Ù† (Ø«Ø§Ù†ÛŒÙ‡)",
      minTimeHint: "Ø­Ø¯Ø§Ù‚Ù„ 120",
      scoresTitle: "Ø§Ù…ØªÛŒØ§Ø²Ù‡Ø§",
      lobby: "Ù„Ø§Ø¨ÛŒ",
      playing: "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø²ÛŒ"
    },
    en: {
      title: "Online Name Game",
      subtitle: "Real-time multiplayer ğŸ®",
      buttons: {
        create: "Create room",
        join: "Join room",
        start: "Start round (Host)",
        end: "End round",
        submit: "Submit answers",
        leave: "Leave room"
      },
      placeholders: { name: "Your name", code: "Room code" },
      categories: {
        name:"Name", family:"Family", city:"City", country:"Country", animal:"Animal",
        food:"Food", fruit:"Fruit", object:"Object", color:"Color", job:"Job"
      },
      timeLabel: "Time (sec)",
      minTimeHint: "Minimum 120",
      scoresTitle: "Scores",
      lobby: "Lobby",
      playing: "Playing"
    },
    fr: {
      title: "Petit Bac en ligne",
      subtitle: "Multijoueur en temps rÃ©el ğŸ®",
      buttons: {
        create: "CrÃ©er une salle",
        join: "Rejoindre",
        start: "DÃ©marrer (HÃ´te)",
        end: "Fin du tour",
        submit: "Envoyer",
        leave: "Quitter"
      },
      placeholders: { name: "Votre nom", code: "Code de salle" },
      categories: {
        name:"PrÃ©nom", family:"Nom", city:"Ville", country:"Pays", animal:"Animal",
        food:"Plat", fruit:"Fruit", object:"Objet", color:"Couleur", job:"MÃ©tier"
      },
      timeLabel: "Temps (sec)",
      minTimeHint: "Minimum 120",
      scoresTitle: "Scores",
      lobby: "Lobby",
      playing: "En jeu"
    }
  };

  let currentLang = localStorage.getItem("lang") || "fa";
  const $ = (id) => document.getElementById(id);

  // UI elements
  const langSelect = $("langSelect");
  const appTitle = $("appTitle");
  const appSubtitle = $("appSubtitle");

  const nameInput = $("nameInput");
  const codeInput = $("codeInput");
  const createBtn = $("createBtn");
  const joinBtn = $("joinBtn");

  const durationSecInput = $("durationSec");
  const startRoundBtn = $("startRoundBtn");
  const endRoundBtn = $("endRoundBtn");
  const submitBtn = $("submitBtn");
  const leaveBtn = $("leaveBtn");

  const lobbyCard = $("lobbyCard");
  const playCard = $("playCard");

  const inputsGrid = $("inputsGrid");
  const roundNum = $("roundNum");
  const letterBox = $("letterBox");
  const timerText = $("timerText");
  const scoresList = $("scoresList");
  const scoresTitle = $("scoresTitle");
  const roomPill = $("roomPill");
  const statusBadge = $("statusBadge");
  const timeLabel = $("timeLabel");
  const minTimeHint = $("minTimeHint");

  let currentRoomCode = null;
  let currentRoomState = null;
  let timerInt = null;

  // enforce min 120
  function clampDuration() {
    const v = Number(durationSecInput.value || 120);
    durationSecInput.value = String(Math.max(120, v));
  }
  durationSecInput.min = 120;
  clampDuration();
  durationSecInput.addEventListener("change", clampDuration);

  langSelect.value = currentLang;
  langSelect.addEventListener("change", () => {
    currentLang = langSelect.value;
    localStorage.setItem("lang", currentLang);
    applyLang();
    renderInputs(); // labels/placeholder update
    renderScoresFromState(); // text update
  });

  function t() { return i18n[currentLang]; }

  function applyLang() {
    appTitle.textContent = t().title;
    appSubtitle.textContent = t().subtitle;

    createBtn.textContent = t().buttons.create;
    joinBtn.textContent = t().buttons.join;
    startRoundBtn.textContent = t().buttons.start;
    endRoundBtn.textContent = t().buttons.end;
    submitBtn.textContent = t().buttons.submit;
    leaveBtn.textContent = t().buttons.leave;

    nameInput.placeholder = t().placeholders.name;
    codeInput.placeholder = t().placeholders.code;

    scoresTitle.textContent = t().scoresTitle;
    timeLabel.textContent = t().timeLabel;
    minTimeHint.textContent = t().minTimeHint;

    // rtl for fa
    document.documentElement.dir = (currentLang === "fa") ? "rtl" : "ltr";
    document.documentElement.lang = currentLang;
  }

  applyLang();

  function isHost() {
    return currentRoomState && currentRoomState.hostSocketId === socket.id;
  }

  function updateStatusUI() {
    if (!currentRoomState) return;
    const playing = currentRoomState.status === "playing";
    playCard.style.display = playing ? "block" : "none";

    statusBadge.textContent = playing ? t().playing : t().lobby;
    statusBadge.className = "badge " + (playing ? "red" : "");

    startRoundBtn.disabled = !isHost();
    endRoundBtn.disabled = !isHost();
  }

  function startTimer(endsAt) {
    clearInterval(timerInt);
    function tick() {
      if (!endsAt) { timerText.textContent = "â€”"; return; }
      const left = Math.max(0, Math.ceil((endsAt - Date.now()) / 1000));
      timerText.textContent = left + "s";
      if (left <= 0) clearInterval(timerInt);
    }
    tick();
    timerInt = setInterval(tick, 500);
  }

  function renderInputs() {
    inputsGrid.innerHTML = "";
    const cats = (currentRoomState?.categories || CATEGORY_KEYS);

    for (const key of cats) {
      const label = t().categories[key] || key;

      const box = document.createElement("div");
      box.className = "card";
      box.style.marginBottom = "0";

      box.innerHTML = `
        <label><span data-cat="${key}">${label}</span></label>
        <input data-answer="${key}" data-ph="${key}" placeholder="${label}" />
      `;
      inputsGrid.appendChild(box);
    }
  }

  function getAnswersFromUI() {
    const ans = {};
    document.querySelectorAll("[data-answer]").forEach(inp => {
      const key = inp.getAttribute("data-answer");
      ans[key] = inp.value || "";
    });
    return ans;
  }

  function renderScores(totals, players) {
    if (!totals || totals.length === 0) {
      scoresList.textContent = (currentLang === "fa") ? "Ù‡Ù†ÙˆØ² Ø§Ù…ØªÛŒØ§Ø²ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡." : "â€”";
      return;
    }
    const mapName = new Map(players.map(p => [p.id, p.name]));
    const sorted = totals.slice().sort((a,b) => (b.score||0) - (a.score||0));

    scoresList.innerHTML = sorted.map(row => {
      const nm = mapName.get(row.id) || "Player";
      return `<div class="scoreRow"><span>${nm}</span><strong>${row.score}</strong></div>`;
    }).join("");
  }

  function renderScoresFromState() {
    if (!currentRoomState) return;
    renderScores(currentRoomState.totals || [], currentRoomState.players || []);
  }

  // Actions
  createBtn.addEventListener("click", () => {
    const name = nameInput.value.trim() || "Player";
    socket.emit("room:create", { name }, (res) => {
      if (!res?.ok) return alert("Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª Ø§ØªØ§Ù‚");
      currentRoomCode = res.code;
    });
  });

  joinBtn.addEventListener("click", () => {
    const name = nameInput.value.trim() || "Player";
    const code = codeInput.value.trim().toUpperCase();
    if (!code) return alert("Ú©Ø¯ Ø§ØªØ§Ù‚ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†");
    socket.emit("room:join", { code, name }, (res) => {
      if (!res?.ok) return alert("Ø§ØªØ§Ù‚ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯");
      currentRoomCode = res.code;
    });
  });

  startRoundBtn.addEventListener("click", () => {
    clampDuration();
    if (!currentRoomCode) return;
    socket.emit("round:start", { code: currentRoomCode, durationSec: Number(durationSecInput.value) }, (res) => {
      if (!res?.ok) alert("ÙÙ‚Ø· Ù…ÛŒØ²Ø¨Ø§Ù† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø´Ø±ÙˆØ¹ Ú©Ù†Ø¯.");
    });
  });

  endRoundBtn.addEventListener("click", () => {
    if (!currentRoomCode) return;
    socket.emit("round:end", { code: currentRoomCode }, (res) => {
      if (!res?.ok) alert("ÙÙ‚Ø· Ù…ÛŒØ²Ø¨Ø§Ù† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù¾Ø§ÛŒØ§Ù† Ø¯Ù‡Ø¯.");
    });
  });

  submitBtn.addEventListener("click", () => {
    if (!currentRoomCode) return;
    socket.emit("submit", { code: currentRoomCode, answers: getAnswersFromUI() }, (res) => {
      if (!res?.ok) alert("Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯ (Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø±Ø§Ù†Ø¯ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯).");
    });
  });

  leaveBtn.addEventListener("click", () => {
    if (!currentRoomCode) return;
    socket.emit("room:leave", { code: currentRoomCode });
    currentRoomCode = null;
    currentRoomState = null;
    roomPill.textContent = "â€”";
    scoresList.textContent = (currentLang === "fa") ? "Ù‡Ù†ÙˆØ² Ø§Ù…ØªÛŒØ§Ø²ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡." : "â€”";
    playCard.style.display = "none";
    statusBadge.textContent = t().lobby;
  });

  // Server events
  socket.on("room:state", (state) => {
    currentRoomState = state;
    currentRoomCode = state.code;
    roomPill.textContent = "ROOM: " + state.code;

    roundNum.textContent = String(state.round || 0);
    letterBox.textContent = state.letter || "â€”";
    startTimer(state.endsAt);

    updateStatusUI();

    // Ø§Ú¯Ø± ÙˆØ§Ø±Ø¯ play Ø´Ø¯Ù‡ØŒ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ Ø±Ø§ Ø±Ù†Ø¯Ø± Ú©Ù†
    if (state.status === "playing") renderInputs();

    // Ø§Ù…ØªÛŒØ§Ø²Ù‡Ø§ Ø§Ø² state
    renderScoresFromState();
  });

  socket.on("scores:update", (payload) => {
    // Ù†Ù…Ø§ÛŒØ´ Ø§Ù…ØªÛŒØ§Ø²Ù‡Ø§ Ø¨Ø§Ù„Ø§ÛŒ ØµÙØ­Ù‡
    if (!currentRoomState) return;
    // totals Ø§Ø² Ø³Ø±ÙˆØ±
    const totals = payload?.totals || [];
    currentRoomState.totals = totals;
    renderScoresFromState();
  });

</script>
</body>
</html>
